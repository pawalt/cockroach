new-cluster localities=us-east-1,us-east-1,us-east-1,us-central-1,eu-central-1,eu-west-1
----

exec-sql idx=0
CREATE DATABASE db PRIMARY REGION "us-east-1" REGIONS  "us-central-1", "eu-central-1";
----

exec-sql idx=0
CREATE TABLE db.rbt(k INT PRIMARY KEY, v INT) LOCALITY REGIONAL BY TABLE IN "us-east-1";
----

exec-sql idx=0
INSERT INTO db.rbt VALUES (1, 1), (2,2)
----

wait-for-zone-config-changes idx=0 table-name=rbt num-voters=3 num-non-voters=2 leaseholder=0 voter=1,2 non-voter=3,4 not-present=5
----

trace-sql idx=0
SELECT * FROM db.rbt WHERE k = 1
----
served locally: true
served via follower read: false

# Sleep to ensure we can get follower reads.
sleep-for-follower-read
----

refresh-range-descriptor-cache idx=1 table-name=rbt
SELECT * FROM db.rbt WHERE k = 1
----
LAG_BY_CLUSTER_SETTING

refresh-range-descriptor-cache idx=2 table-name=rbt
SELECT * FROM db.rbt WHERE k = 1
----
LAG_BY_CLUSTER_SETTING

# Servers 1 and 2 are voters, so we should only be able to get
# follower reads.

trace-sql idx=1
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

trace-sql idx=1
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: true
served via follower read: true

trace-sql idx=2
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

trace-sql idx=2
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: true
served via follower read: true

refresh-range-descriptor-cache idx=3 table-name=rbt
SELECT * FROM db.rbt WHERE k = 1
----
LAG_BY_CLUSTER_SETTING

refresh-range-descriptor-cache idx=4 table-name=rbt
SELECT * FROM db.rbt WHERE k = 1
----
LAG_BY_CLUSTER_SETTING

# us-central-1 and eu-central-1 are non-voters, so we should only be able to get
# follower reads.
trace-sql idx=3
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

trace-sql idx=3
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: true
served via follower read: true

trace-sql idx=4
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

trace-sql idx=4
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: true
served via follower read: true

# We now alter to RESTRICTED placement. We should now have the same zone config
# but without non-voters.
exec-sql idx=0
ALTER DATABASE db SET PLACEMENT RESTRICTED;
----

wait-for-zone-config-changes idx=0 table-name=rbt num-voters=3 num-non-voters=0 leaseholder=0 voter=1,2 not-present=3,4,5
----

# Should still be able to serve reads from leaseholder
trace-sql idx=0
SELECT * FROM db.rbt WHERE k = 1
----
served locally: true
served via follower read: false

sleep-for-follower-read
----

# Servers 1 and 2 are still voters, so we should only be able to get
# follower reads.

trace-sql idx=1
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

trace-sql idx=1
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: true
served via follower read: true

trace-sql idx=2
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

trace-sql idx=2
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: true
served via follower read: true

# us-central-1 and eu-central-1 are not non-voters, so we should not be able to
# get any local reads.

trace-sql idx=3
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

trace-sql idx=3
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: false

trace-sql idx=4
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

trace-sql idx=4
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: false

# We'll now add a region to the database and ensure that non-voters do not get
# issued to it.

exec-sql idx=0
ALTER DATABASE db ADD REGION "eu-west-1";
----

# We technically don't have to do a wait here, but it's worth being explicit
# about what replica behavior we expect post-region addition.
wait-for-zone-config-changes idx=0 table-name=rbt num-voters=3 num-non-voters=0 leaseholder=0 voter=1,2 not-present=3,4,5
----

refresh-range-descriptor-cache idx=5 table-name=rbt
SELECT * FROM db.rbt WHERE k = 1
----
LAG_BY_CLUSTER_SETTING

trace-sql idx=5
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

trace-sql idx=5
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: false

# Finally, let's uncork by switching back to DEFAULT placement and ensuring
# we can perform follower reads from all regions.

# We now alter to DEFAULT placement. We should now have the same zone config but
# with non-voters in all regions except us-east-1.
exec-sql idx=0
ALTER DATABASE db SET PLACEMENT DEFAULT;
----

wait-for-zone-config-changes idx=0 table-name=rbt num-voters=3 num-non-voters=3 leaseholder=0 voter=1,2 non-voter=3,4,5
----

sleep-for-follower-read
----

refresh-range-descriptor-cache idx=3 table-name=rbt
SELECT * FROM db.rbt WHERE k = 1
----
LAG_BY_CLUSTER_SETTING

refresh-range-descriptor-cache idx=4 table-name=rbt
SELECT * FROM db.rbt WHERE k = 1
----
LAG_BY_CLUSTER_SETTING

refresh-range-descriptor-cache idx=5 table-name=rbt
SELECT * FROM db.rbt WHERE k = 1
----
LAG_BY_CLUSTER_SETTING

# Now that we've altered to default, we should be able to serve follower reads
# from all regions
trace-sql idx=3
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: true
served via follower read: true

trace-sql idx=4
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: true
served via follower read: true

trace-sql idx=5
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: true
served via follower read: true
